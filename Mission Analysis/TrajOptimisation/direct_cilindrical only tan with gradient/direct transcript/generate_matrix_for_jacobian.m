clear all
syms t1 t2
A=[1 0 0 0 t1 0 0 0 t1^2 0 0 0 t1^3 0 0 0;
    0 1 0 0 0 t1 0 0 0 t1^2 0 0 0 t1^3 0 0;
    0 0 1 0 0 0 t1 0 0 0 t1^2 0 0 0 t1^3 0;
    0 0 0 1 0 0 0 t1 0 0 0 t1^2 0 0 0 t1^3;
    1 0 0 0 t2 0 0 0 t2^2 0 0 0 t2^3 0 0 0;
    0 1 0 0 0 t2 0 0 0 t2^2 0 0 0 t2^3 0 0;
    0 0 1 0 0 0 t2 0 0 0 t2^2 0 0 0 t2^3 0;
    0 0 0 1 0 0 0 t2 0 0 0 t2^2 0 0 0 t2^3;
    0 0 0 0 1 0 0 0 2*t1 0 0 0 3*t1^2 0 0 0;
    0 0 0 0 0 1 0 0 0 2*t1 0 0 0 3*t1^2 0 0;
    0 0 0 0 0 0 1 0 0 0 2*t1 0 0 0 3*t1^2 0;
    0 0 0 0 0 0 0 1 0 0 0 2*t1 0 0 0 3*t1^2;
    0 0 0 0 1 0 0 0 2*t2 0 0 0 3*t2^2 0 0 0;
    0 0 0 0 0 1 0 0 0 2*t2 0 0 0 3*t2^2 0 0;
    0 0 0 0 0 0 1 0 0 0 2*t2 0 0 0 3*t2^2 0;
    0 0 0 0 0 0 0 1 0 0 0 2*t2 0 0 0 3*t2^2];
A_inv=A\eye(16);
%h=(t2-t1)/2;
phi(t1,t2)=[1 0 0 0 (t1+t2)/2 0 0 0 ((t1+t2)/2)^2 0 0 0 ((t1+t2)/2)^3 0 0 0;
       0 1 0 0 0 (t1+t2)/2 0 0 0 ((t1+t2)/2)^2 0 0 0 ((t1+t2)/2)^3 0 0;
       0 0 1 0 0 0 (t1+t2)/2 0 0 0 (t1+t2)/2^2 0 0 0 ((t1+t2)/2)^3 0;
       0 0 0 1 0 0 0 (t1+t2)/2 0 0 0 ((t1+t2)/2)^2 0 0 0 ((t1+t2)/2)^3]*A_inv;
phi_d(t1,t2)=[0 0 0 0 1 0 0 0 2*(t1+t2)/2 0 0 0 (3*(t1+t2)/2)^2 0 0 0;
       0 0 0 0 0 1 0 0 0 2*(t1+t2)/2 0 0 0 (3*(t1+t2)/2)^2 0 0;
       0 0 0 0 0 0 1 0 0 0 2*(t1+t2)/2 0 0 0 (3*(t1+t2)/2)^2 0;
       0 0 0 0 0 0 0 1 0 0 0 2*(t1+t2)/2 0 0 0 (3*(t1+t2)/2)^2]*A_inv;
syms x1 x2 x3 x4 u x1_2 x2_2 x3_2 x4_2 u_2 h
syms x1c x2c x3c x4c uc

f(x1c,x2c,x3c,x4c,u)=[x3c/x2c; x4c; -(x4c*x3c/x2c)+uc; (x3c^2/x2c)-1/(x2c^2)];
 
df_dx(x1c,x2c,x3c,x4c,uc)=[diff(f,x1c),diff(f,x2c),diff(f,x3c),diff(f,x4c)]';
du_dxu=[0;0;0;0;0.5;0;0;0;0;0.5];
% du_dxu=[0;0;0;0;0.5];%0.5;0;0;0;0;0.5];
df_du(x1c,x2c,x3c,x4c,uc)=diff(f,uc);
b(x1,x2,x3,x4,u, x1_2, x2_2, x3_2, x4_2, u_2,h)=[x1;x2;x3;x4; x1_2; x2_2; x3_2; x4_2; (h/2)*x3/x2; (h/2)*x4; (h/2)*(-(x4*x3/x2)+u); (h/2)*(x3^2/x2-1/(x2^2));(h/2)*x3_2/x2_2; (h/2)*x4_2; (h/2)*(-(x4_2*x3_2/x2_2)+u_2); (h/2)*(x3_2^2/x2_2-1/(x2_2^2))];
db_dxu(x1,x2,x3,x4,u, x1_2, x2_2, x3_2, x4_2, u_2,h)=[diff(b,x1),diff(b,x2),diff(b,x3),diff(b,x4),diff(b,u),diff(b,x1_2),diff(b,x2_2),diff(b,x3_2),diff(b,x4_2),diff(b,u_2)];
% db_dxu(x1,x2,x3,x4,u, x1_2, x2_2, x3_2, x4_2, u_2,h)=[diff(b,x1),diff(b,x2),diff(b,x3),diff(b,x4),diff(b,u)];%,diff(b,x1_2),diff(b,x2_2),diff(b,x3_2),diff(b,x4_2),diff(b,u_2)];

d_residual(t1,t2,x1,x2,x3,x4,u,x1c,x2c,x3c,x4c,uc, x1_2, x2_2, x3_2, x4_2, u_2,h)=phi_d(t1,t2)*db_dxu(x1,x2,x3,x4,u, x1_2, x2_2, x3_2, x4_2, u_2,h)-(h/2)*(df_dx(x1c,x2c,x3c,x4c,uc)*phi(t1,t2)*db_dxu(x1,x2,x3,x4,u, x1_2, x2_2, x3_2, x4_2, u_2,h)+df_du(x1c,x2c,x3c,x4c,uc)*du_dxu');
